#!/bin/sh

# MineMaster Docker Deploy Script
# Deploys the MineMaster server (API + admin dashboard) as a single container
# Works with nginx-proxy for subdomain routing via VIRTUAL_HOST env var

set -e

# Auto-detect which Docker network the nginx-proxy container is on
NGINX_PROXY_CONTAINER="nginx-proxy"
NETWORK_NAME=""

if sudo docker inspect "$NGINX_PROXY_CONTAINER" >/dev/null 2>&1; then
    # Get the first network nginx-proxy is connected to
    NETWORK_NAME=$(sudo docker inspect "$NGINX_PROXY_CONTAINER" \
        --format '{{range $key, $val := .NetworkSettings.Networks}}{{$key}}{{end}}' \
        | head -1)
    echo "Detected nginx-proxy on network: $NETWORK_NAME"
else
    echo "WARNING: nginx-proxy container not found. Using default bridge network."
    NETWORK_NAME="bridge"
fi

# Read VIRTUAL_HOST from .env for logging
if [ -f ".env" ]; then
    VIRTUAL_HOST=$(grep -E '^VIRTUAL_HOST=' .env | cut -d'=' -f2-)
fi

# Build the new image first (minimizes downtime)
echo "Building MineMaster image..."
sudo DOCKER_BUILDKIT=1 docker build -t minemaster:latest .

# Stop and remove old container if it exists (by ID and by name for safety)
if [ -f "container.id" ]; then
    CONTAINER_ID=$(cat container.id)
    if [ -n "$CONTAINER_ID" ]; then
        echo "Stopping old container: $CONTAINER_ID"
        sudo docker stop "$CONTAINER_ID" 2>/dev/null || true
        sudo docker rm "$CONTAINER_ID" 2>/dev/null || true
    fi
fi
# Also remove by name in case container.id was stale
sudo docker stop minemaster 2>/dev/null || true
sudo docker rm minemaster 2>/dev/null || true

# Run the new container
# - Attached to same network as nginx-proxy (for internal routing by VIRTUAL_HOST)
# - No host port mapping needed (nginx-proxy connects internally)
# - env-file provides VIRTUAL_HOST, VIRTUAL_PORT, MONGO_*, JWT_SECRET, etc.
echo "Starting MineMaster container on network: $NETWORK_NAME"
NEW_CONTAINER_ID=$(sudo docker run \
    --network "$NETWORK_NAME" \
    --env-file=.env \
    -e NODE_ENV=production \
    --restart unless-stopped \
    --name minemaster \
    -d minemaster:latest)

echo "$NEW_CONTAINER_ID" > container.id

echo ""
echo "Deployment complete."
echo "Container: $NEW_CONTAINER_ID"
echo "Network:   $NETWORK_NAME"
if [ -n "$VIRTUAL_HOST" ]; then
    echo "Dashboard: https://$VIRTUAL_HOST"
    echo "API:       https://$VIRTUAL_HOST/api"
    echo "WebSocket: wss://$VIRTUAL_HOST"
fi
echo ""
echo "Logs: sudo docker logs -f minemaster"
